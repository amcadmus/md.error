\documentclass[a4paper]{article}

\usepackage[dvips]{graphicx}


\begin{document}
\noindent
Dear Prof. Rothlisberger,\\

Thank you very much for the reports. We would like to thank also the
reviewers for the positive reports and for the suggestions, which help
us improving the quality of the manuscript. The revisions are
reported below in detail.\\

In the revised manuscript, all the major additions are marked in red, to help the
reviewers to located them immediately in the text.\\

\noindent
Reviewer  1 Comments:\\

\textit{ At a glance, the paper by Han Wang and colleagues appears to
  be another error estimator for P3M and related electrostatics
  methods.  But, after taking in the second paragraph it becomes clear
  that the authors are much more than mathematically inclined on the
  subject, and have indeed performed a useful service to the
  simulations community by incorporating the correlation of molecular
  charges into their error estimates.  It is probably not of
  tremendous practical benefit in an application like an Ewald
  parameter optimizer, as these programs can just repeat an
  electrostatic calculation on a representative snapshot of a
  simulation and estimate the error directly from the resulting
  forces.  However, it is of value to have a formal expression for the
  effect of charge correlations on these errors, and it may be
  instrumental in devising a pairwise approximate correction to
  electrostatic forces obtained from coarse grids.  The paper will
  require minor modifications so that the authors do not run afoul of
  various members of the community who hold strong opinions, but
  otherwise appears to be fit for publication.
}

We have modified the introduction according to this point.
Please see the 4-th line of the second paragraph of the introduction:
\textbf{
  This problem can be solved by  comparing
  the forces calculated by
  using different parameter sets
  on a representative snapshot of the system,
  see e.g. Ref.[16].
An other approach is the 
  in-depth theoretical study
of the error introduced by the algorithms, namely the
error estimate,
by which the error is described by a function of the working
parameters...
}\\

\textit{ In the introduction, the authors should probably take the
  perspective that SPME is a special case of P3M.  In the opinions of
  the developers of SPME, the derivation differs from P3M although it
  leads to similar results, but even TA Darden acknowledges that the
  reciprocal space component of the non-smooth PME algorithm was
  inspired by P3M.  It is probably best to phrase SPME as such and not
  offend anyone.  The interlacing technique was first applied in the
  1970s, as the authors have cited.  It was originally a means of
  reducing the memory requirements of these
  calculations—electrostatics on the two grids were solved serially.
  Finally, the sentence ``We prove that the error is decomposed...''
  should be changed to ``We show that the error may be approximately
  decomposed...'' to indicate that the estimator is, in the end,
  approximate but relevant to real systems.
}

We have added the comment (see the 12-th line of the 1st paragraph
of the introduction:
\textbf{It has been demonstrated that the SPME is actually
  a special case of the P3M method [6,7].}
The sentence ``We prove that the error is decomposed...'' has been
changed to \textbf{We show that the error may be approximately
  decomposed...}, please see the 4-th line of the third paragraph of the
introduction.
\\

\textit{ Cosmetically, the authors should combine the two figures
  showing the charge distributions of Examples 1 and 2, to ensure they
  appear side-by-side in the published version.
}

We delete the old Fig.3,
and plot the charge distribution of Example 2 together
with Example 1 in the new Fig.2. Changes to the caption and
descriptions have been made correspondingly.\\

\textit{
The authors are reasonable to focus on the error arising from the
reciprocal space approximations in the various P3M-related methods;
the error arising from the direct space part of the calculation is
simpler to assess.  However, because the authors give so much
attention to SPME and the Staggered Mesh method which, as published,
built on SPME, the authors should include some plot of the effect of
grid spacing, Gaussian smoothing function width (Ewald coefficient),
and interpolation order -- these are the determinants of the accuracy of
the reciprocal space calculation in these fast methods.  How does the
estimator do in terms of getting the various trends correct?  What is
the effect of correlated charge positions on the error and the
estimates under changing interpolation order?  This is at the heart of
the difference between ik- and analytic differentiation that the
authors have otherwise carefully investigated.  It would also be
helpful to see a plot of the error estimator’s performance as a
function of the “near neighbor” definition.  Define near neighbors
strictly by length, and plot the error estimator's accuracy as a
continuous function of the near neighbor cutoff.  Extra credit for
detailing the computation time as a function of the same parameter!
}

We add new Fig. 9-12 to show how the error estimates
with bonded nearest neighbor approximations are able to catch the
trends of the real errors with various Ewald coefficient $\beta$, direct space
cut-off radius $r_c$, reciprocal space grid spacing $h$ and B-spline
interpolation order $n$.
Please also see the discussions added
from the last line of page 29.
% These figures show the error estimate
% with the bonded nearest neighbor approximation correctly catches the
% trend of changing working parameters.

In the revised manuscript,
we consider both of the two types of the correlations:
(1) the bonded correlation
that originates from the rigid H-O
bond and H-O-H angle within one molecule,
and (2) the
non-bonded correlation or the
intermolecular correlation that originates from
a complex coupling of various intermolecular interactions.
Estimates for the bonded correlation
have already been developed by the old manuscript,
while the non-bonded estimate
is newly added according to the reviewers' suggestion.
The nearest neighbors are defined by neighbors closer than
a neighboring range $R_g$.
The non-bonded nearest neighbor approximation 
is expressed in terms of the radial distribution
functions (RDFs), see the new Eq. (21) and (22).
Please note that
both the bonded and non-bonded nearest neighbor approximations
require some uniformity of the correlation in the system:
the bonded estimate requires the uniformity of the water
direction preference (as has been discussed in the old manuscript),
while the non-bonded estimate requires the uniformity
of the density distribution and the isotropicity of the system.
Otherwise the cost of the error estimate would be $\mathcal O(N^2\log N)$.
In example 3, a global RDF is not well defined,
so we calculated the RDF and nearest neighbor approximation
only for the liquid phase, see the dotted line in Fig.7. By adding
the non-bonded correlation, the quality of the error estimate
is further improved.
Also the convergence with respect to
the neighboring range $R_g$ is investigated, see Fig.8.
Relevant changes to the manuscript
have been made on page 9,
11 (4-th line from the bottom), 12, 29 (12-th line). All changes are marked 
in red for convenience.
\\



\textit{
One other point of discussion that might be relevant to this paper is
the significance of the results on force-shifted coulomb interactions
(see the simulation methods of Valerie Dagget and colleagues, or the
Wolfe Method as reviewed in J. Chem. Phys. 124:234104 and elsewhere).
These methods, based strictly on local “electrostatic” interactions
computed by modifying Coulomb’s law, are often trotted out as
alternatives to Ewald summation though their application is still
limited (which is, in the opinion of this reviewer, as it should be).
A principal assumption of these methods, which is often used
circuitously to defend their application, is that real systems are
locally neutral or that electrostatic correlations decay on the length
scale of a few water layers.  Wang and colleagues may be able to
analyze these methods, provide insights into the appearance of their
validity, and identify their limitations rigorously.  A formal
analysis of these methods is not required for this paper, but a
possible direction the authors might explore in the future.
}

We gratefully thank the reviewer for the suggestion of an interesting
extension of the present work.\\

\textit{
The authors have done an excellent job of manipulating the
mathematical foundations of these fast electrostatics methods.  With
minor modifications and extensions of the study, which this reviewer
does not intend to be onerous, this work should be published without
further hindrance.
}\\



\noindent
Reviewer  2 Comments:\\

\textit{ The article deals with the derivation of an accurate error
  estimate for the Ewald and SPME mesh Ewald method that can be used
  for inhomogeneous and correlated charged systems.
}

\textit{
Error estimates for long range algorithms are always useful for
periodic charged systems, since due to the long range nature, no exact
calculation is possible, but one rather has to truncate the
interactions at some point, and hence is forced to introduce errors.
Ideally, one would like to know for a specific method before doing an
expensive calculation how to choose method parameters such that I
reach a certain accuracy. Such error estimates have been developed in
the past, but normally only under the assumption that the charges are
randomly distributed. Here, the authors extend these error estimates
to the very relevant cases of inhomogeneous and/or correlated systems.
}

\textit{
  I find the article in general very readable and informative, and
  also suited for this journal. I have just a few comments that the
  authors might want to take into account in a minor revised version,
  before this article, in my opinion, is ready for publication:
}\\

\textit{ Page 7, line 23: The definition of a discrete set of nearest
  neighbors $\Omega_j$ might not readily avaible in all cases. For
  example, for simple liquids it may be more feasible to use the
  radial distribution function $g(r)$ up to a certain radius $r_c$,
  where $g(r) \approx 1$ for $r > r_c$. Then the sum has to be
  replaced by an integral over $r$.  Because of the close relation of
  $\rho^{(2)}$ and $g(r)$, the equations should be easy to adapt to
  such a notation.  }

In the revised manuscript,
we consider both of the two types of the correlations:
(1) the bonded correlation
that originates from the rigid H-O
bond and H-O-H angle within one molecule,
and (2) the
non-bonded correlation or the
intermolecular correlation that originates from
a complex coupling of various intermolecular interactions.
Estimates for the bonded correlation
have already been developed by the old manuscript,
while the non-bonded estimate
is newly added according to the reviewers' suggestion.
The nearest neighbors are defined by neighbors closer than
a neighboring range $R_g$ (i.e. the $r_c$ in the reviewer's comment).
The non-bonded nearest neighbor approximation 
is expressed in terms of the radial distribution
functions (RDFs), see the new Eq. (21) and (22).
Please note that
both the bonded and non-bonded nearest neighbor approximations
require some uniformity of the correlation in the system:
the bonded estimate requires the uniformity of the water
direction preference (as has been discussed in the old manuscript),
while the non-bonded estimate requires the uniformity
of the density distribution and the isotropicity of the system, which
are also the prerequisites for reducing $\rho^{(2)}$ to $g(r)$.
Otherwise the cost of the error estimate would be $\mathcal O(N^2\log N)$.
In example 3, a global RDF is not well defined (because the system is inhomogeneous),
so we calculated the RDF and nearest neighbor approximation
only for the liquid phase, see the dotted line in Fig.7. By adding
the non-bonded correlation, the quality of the error estimate
is further improved.
Also the convergence with respect to
the neighboring range $R_g$ is investigated, see Fig.8.
Relevant changes to the manuscript
have been made on page 9,
11 (4-th line from the bottom), 12, 29 (12-th line). All changes are marked 
in red for convenience.
\\


\textit{ Page 15, line 45: I believe I saw that the for interlaced
  P$^3$M algorithm, which is very similar to the staggered SMPE
  algorithm, the approximation to leading order of the error estimate
  is not justified, at least for higher precisions. This approximation
  could lead to a visible deviation from the true errors. In this
  context it might be useful to recalculate the numerical examples at
  higher precision. Usually, deviations start to be visible from about
  an RMS of $10^{-4}$.  }

\textit{ Page 16, line 34: Again, In the very similarly structured
  interlaced P$^3$M algorithm, there are differences in accuracy
  between the $i\mathbf{k}$- and analytical differentiation at higher
  precisions. At this point it might not be justified to assume that
  both can be treated in the same way. Similarly to the approximation
  of the $i\mathbf{k}$ error formula, it would be useful to do
  calculations at higher precision than those presented in the paper,
  and compare them. }

As far as we concerned,
direct error estimates with the higher order terms are not easy.
Therefore, we investigate this issue in another way:
we compare the estimate (with bonded nearest neighbor
approximation) with the real error of the randomized COM test
(see the description of this test at the 4th line from bottom of page 28).
Since the only approximation made in the estimate is the leading order
approximation, the difference between the estimate and the real error
of randomized COM test is actually the contribution from the higher
order terms discarded by (48) and (53).
In Fig. 9-12,
we check this difference in a wide parameter range, and see in most
cases the estimate overlaps with the real error, which means
the leading order is a good approximation. 
However,
we do observe exceptions
at large $\beta$ when the grid spacing is $h=0.248\:\textsf{nm}$,
see Fig.11, and
at small $\beta$ when the interpolation order is $n=4$,
see Fig.12.
That means the higher order terms may play a role in the staggered
mesh interpolation errors. It also explains the unexpected discrepancy
between the staggered mesh ik- and analytical differentiation
at small $\beta$, $n=4$.
Relevant changes to the manuscript
have been made on page 28 (5-th line from the bottom), 32 (5-th line from the bottom).
\\


% if the lead order
% is a good approximation, then two consequences are implied: (1) the
% equivalency of the staggered mesh ik- and analytical differentiation;
% (2) the overlapping of the estimate (with non-bonded nearest neighbor
% approximation) with the real error of the randomized COM testing case
% (see the description of this testing case in page 25).  In Fig. 9-12
% we check these two points for a wide parameter range, and see in most
% cases they are correct. This provide a strong evidence for the
% justification of the leading order approximation.



\textit{ The manuscript contains a few misprints, and the language
  could be polished on a few occasions by a native speaker.  }


\vskip 1cm
\noindent
Reviewer 3 Comments:\\

\textit{
The authors have introduced a way to study electrostatic force errors
in correlated systems by assuming that the dominant correlations are
short-ranged which should usually work--they acknowledge this may not
work for systems near phase transitions. I like this paper and would
like to see it published after minor complaints are addressed.
}

\textit{
Firstly, the main contribution is to introduce a way to rapidly
evaluate the force error, including that due to short ranged (bonded)
pair interactions. Some readers may be confused by this, since bonded
pair electrostatic interactions are considered to be NOT
CALCULATED. However, in Ewald like methods the reciprocal contribution
cannot be easily excluded for atom pairs and is surprisingly large
even for bonded pairs. I think including this point somewhere in the
discussion will help many readers. Note that errors for bonded pairs
may be at least partly responsible for the disappointing performance
of multiple time step methods. (they are high frequency in time)
}

% \begin{figure}
%   \centering
%   \includegraphics[width=0.7\textwidth]{correlation.eps}
%   \caption{The schematic plot of two interacting water molecules.
%     When we calculate the force error of the left oxygen atom, the
%     correlation with its bonded hydrogens are not considered, but
%     the correlations within any neighboring molecule are considered,
%     as indicated by the solid lines with two arrows.}
%   \label{fig:1}
% \end{figure}

We define the force error by inserting a testing charge into the
considered system, and comparing the calculated and exact force on
it. In the considered water system (Example 3), the subtle difference
between this setting to the realistic case is that the testing charge
has no correlation with the charges in the system, while any real
charge is bonded to two neighboring charges (via H-O bond and H-O-H
angle), as is illustrated by the new Fig.1.
% Therefore, the error estimate does not consider the
% correlation between a charge and the its bonded neighbors, but it does
% consider all bonding correlations within any neighboring molecule (see
% new Fig.1 of the paper).
This definition is actually consistent with the usually
setting of bonded pair atoms, as mentioned by the reviewer, the
electrostatic interaction between them is not calculated.
Throughout this paper, we remove this  interaction from the
standard long-range algorithms.  This discuss has been added to
the manuscript, see from the 3rd line under Eq.20.


% We therefore added the following sentence to make this point clearer:
% \textbf{
%   We define the force error by inserting a
% testing charge into the water system, and comparing the
% calculated and exact force on it. This definition implicitly assumes
% the independency between the testing particle and the
% system. Therefore, it sould be noted that the correlation error
% estimate (20)
% neglects the possible bonding
% of the testing particle to any hydrogen/oxygen atom, and
% calculates all bonded correlations
% within its {neighboring} molecules. This is consistent
% with the usual setting of the bonded atoms: the electrostatic interaction
% between them is considered to be \emph{not} calculated.}

The inclusion of the correlation between the testing
charge and the system is also possible, but this is beyond the scope
of the present paper, and will be addressed in the following studies.\\

% Therefore, in all the estimates, the error due to the
% bonded pair interactions is automatically eliminated by the
% definition. 

% The inclusion of the correlation between the testing
% charge and the system is also possible, but this is beyond the scope
% of the present paper, and will be addressed in the following studies.
% To make this point clearer, we add the following sentence:
% \textbf{Here we implicitly assumes that the testing particle is independent
% with the system, but it is not the case in real systems. For example,
% in the water system considered in Sec.III, each atom is bonded
% to two neighboring atoms (via the rigid H-O bond and H-O-H angle).
% Fortunately, this may not be a big problem, firstly because the bonded pair
% electrostatic interacions are considert to be \emph{not} calculated;
% secondly because the non-bonded pair correlation contributes only
% minority part to the total error (see also Sec.III).}

% As a matter of fact, in Example 3, the electrostatic interactions
% within one water molecule is \emph{not} calculated. This may not be
% computationally economic in practice, however, it is important to
% remove it in our theoretical study, becuase, as mensioned by the
% reviewer, the bonded pair electrostatic interaction is considered to
% be not calculated.


\textit{
I am curious about the fact that correlation reduces force errors
compared to usual estimates. I wonder if this is somehow due to
electrostatic forces on bonded pairs being anti-correlated due to
opposing charge signs e.g. on Oxygen and Hydrogens of $H_2O$.
}

As far as we concerned, it is not possible to test this point
directly, but we think it is a likely explanation to the observed
phenomenon.  Consider the extreme case: within one molecule, the
hydrogen and oxygen atoms locate at the same point (strongest
correlation), then the positive and negative charges cancel, so the
error vanishes. In the case of TIP3P water model, the H-O distance is 0.1~nm,
which is much smaller than the typical
center-of-mass distance between two neighboring molecules (0.31~nm),
therefore, the bonded correlation tends to neutralize the molecule
and reduce the force error.
We have added this point to the paper, see line 10 on page 28.
\\

\textit{
Otherwise I have a number of minor grammatical and typo complaints:
}

The grammatical mistakes and typos have been corrected according to the reviewer.
% We want to explain two points:\\

% \textit{
% page 4 line 18 ``error estimate for the error force'' seems like 1st ``error'' is unnecessary
%               perhaps replace with ``following estimate for the error force''---also the term ``error force'' could be
%               replaced with ``force error'' here and elsewhere and I think the text would flow better
%             }
            
% We use ``error force'' because we want to stress it is a force, not a error, which may be a scalor, and be confused with the ``RMS force error''.\\

% \textit{
% page 24 line 11: ``the error is of good property'' Not clear what is meant. Do you mean total error is not
%                  contaminated by this?
%                }
               
%                Yes, the we removed ``the error is of good property'',
%                the logic of the sentence is




\end{document}

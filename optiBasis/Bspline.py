#!/usr/bin/env python3

import sys
import numpy as np
import matplotlib.pyplot as plt

def test () :
    print ("here")

def _make_bspline_coeff (order) :    

    mat = np.zeros ((order, order), dtype = float)    

    if order == 2:
        mat[0][0] = 0.00000000000000000e+00
        mat[0][1] = 1.00000000000000000e+00
        mat[1][0] = 2.00000000000000000e+00
        mat[1][1] = -1.00000000000000000e+00

    elif order == 4:
        mat[0][0] = 0.00000000000000000e+00
        mat[0][1] = 0.00000000000000000e+00
        mat[0][2] = 0.00000000000000000e+00
        mat[0][3] = 1.66666666666666657e-01
        
        mat[1][0] = 6.66666666666666630e-01
        mat[1][1] = -2.00000000000000000e+00
        mat[1][2] = 2.00000000000000000e+00
        mat[1][3] = -5.00000000000000000e-01
    
        mat[2][0] = -7.33333333333333304e+00
        mat[2][1] = 1.00000000000000000e+01
        mat[2][2] = -4.00000000000000000e+00
        mat[2][3] = 5.00000000000000000e-01
    
        mat[3][0] = 1.06666666666666661e+01
        mat[3][1] = -8.00000000000000000e+00
        mat[3][2] = 2.00000000000000000e+00
        mat[3][3] = -1.66666666666666657e-01

    elif order == 6:
        mat[0][0] = 0.00000000000000000e+00
        mat[0][1] = 0.00000000000000000e+00
        mat[0][2] = 0.00000000000000000e+00
        mat[0][3] = 0.00000000000000000e+00
        mat[0][4] = 0.00000000000000000e+00
        mat[0][5] = 8.33333333333333322e-03

        mat[1][0] = 4.99999999999999958e-02
        mat[1][1] = -2.49999999999999972e-01
        mat[1][2] = 5.00000000000000000e-01
        mat[1][3] = -5.00000000000000000e-01
        mat[1][4] = 2.50000000000000000e-01
        mat[1][5] = -4.16666666666666644e-02
        
        mat[2][0] = -3.94999999999999973e+00
        mat[2][1] = 9.75000000000000000e+00
        mat[2][2] = -9.50000000000000000e+00
        mat[2][3] = 4.50000000000000000e+00
        mat[2][4] = -1.00000000000000000e+00
        mat[2][5] = 8.33333333333333426e-02
        
        mat[3][0] = 3.65499999999999972e+01
        mat[3][1] = -5.77500000000000000e+01
        mat[3][2] = 3.55000000000000000e+01
        mat[3][3] = -1.05000000000000000e+01
        mat[3][4] = 1.50000000000000000e+00
        mat[3][5] = -8.33333333333333426e-02
        
        mat[4][0] = -9.14499999999999886e+01
        mat[4][1] = 1.02249999999999986e+02
        mat[4][2] = -4.45000000000000000e+01
        mat[4][3] = 9.50000000000000000e+00
        mat[4][4] = -9.99999999999999889e-01
        mat[4][5] = 4.16666666666666644e-02
        
        mat[5][0] = 6.47999999999999972e+01
        mat[5][1] = -5.39999999999999858e+01
        mat[5][2] = 1.80000000000000000e+01
        mat[5][3] = -3.00000000000000000e+00
        mat[5][4] = 2.49999999999999972e-01
        mat[5][5] = -8.33333333333333322e-03
    elif order == 8 :
        mat[0][0] = 0.00000000000000000e+00
        mat[0][1] = 0.00000000000000000e+00
        mat[0][2] = 0.00000000000000000e+00
        mat[0][3] = 0.00000000000000000e+00
        mat[0][4] = 0.00000000000000000e+00
        mat[0][5] = 0.00000000000000000e+00
        mat[0][6] = 0.00000000000000000e+00
        mat[0][7] = 1.98412698412698385e-04
        mat[1][0] = 1.58730158730158708e-03
        mat[1][1] = -1.11111111111111081e-02
        mat[1][2] = 3.33333333333333329e-02
        mat[1][3] = -5.55555555555555525e-02
        mat[1][4] = 5.55555555555555525e-02
        mat[1][5] = -3.33333333333333259e-02
        mat[1][6] = 1.11111111111111098e-02
        mat[1][7] = -1.38888888888888873e-03
        mat[2][0] = -7.09523809523809557e-01
        mat[2][1] = 2.47777777777777786e+00
        mat[2][2] = -3.69999999999999973e+00
        mat[2][3] = 3.05555555555555536e+00
        mat[2][4] = -1.50000000000000000e+00
        mat[2][5] = 4.33333333333333293e-01
        mat[2][6] = -6.66666666666666519e-02
        mat[2][7] = 4.16666666666666661e-03
        mat[3][0] = 2.35904761904761919e+01
        mat[3][1] = -5.42222222222222285e+01
        mat[3][2] = 5.30000000000000000e+01
        mat[3][3] = -2.84444444444444429e+01
        mat[3][4] = 8.99999999999999822e+00
        mat[3][5] = -1.66666666666666652e+00
        mat[3][6] = 1.66666666666666657e-01
        mat[3][7] = -6.94444444444444406e-03
        mat[4][0] = -2.03965079365079362e+02
        mat[4][1] = 3.44000000000000057e+02
        mat[4][2] = -2.45666666666666686e+02
        mat[4][3] = 9.60000000000000000e+01
        mat[4][4] = -2.21111111111111107e+01
        mat[4][5] = 3.00000000000000000e+00
        mat[4][6] = -2.22222222222222210e-01
        mat[4][7] = 6.94444444444444406e-03
        mat[5][0] = 6.64090476190476352e+02
        mat[5][1] = -8.71277777777777601e+02
        mat[5][2] = 4.83499999999999943e+02
        mat[5][3] = -1.47055555555555543e+02
        mat[5][4] = 2.64999999999999964e+01
        mat[5][5] = -2.83333333333333304e+00
        mat[5][6] = 1.66666666666666630e-01
        mat[5][7] = -4.16666666666666661e-03
        mat[6][0] = -8.91109523809523580e+02
        mat[6][1] = 9.43122222222222035e+02
        mat[6][2] = -4.23699999999999932e+02
        mat[6][3] = 1.04944444444444414e+02
        mat[6][4] = -1.54999999999999964e+01
        mat[6][5] = 1.36666666666666647e+00
        mat[6][6] = -6.66666666666666519e-02
        mat[6][7] = 1.38888888888888873e-03
        mat[7][0] = 4.16101587301587244e+02
        mat[7][1] = -3.64088888888888846e+02
        mat[7][2] = 1.36533333333333303e+02
        mat[7][3] = -2.84444444444444393e+01
        mat[7][4] = 3.55555555555555536e+00
        mat[7][5] = -2.66666666666666607e-01
        mat[7][6] = 1.11111111111111081e-02
        mat[7][7] = -1.98412698412698385e-04
    else :
        raise RuntimeError ("order %d not implemented!", order)

    return mat

def _make_bspline_d_coeff (order) :
    if (order != 4): 
        raise RuntimeError ("order other than 4 not implemented!")
    mat = np.zeros ((order, order-1), dtype = float)

    if order == 2: 
        mat[0][0] = 1.00000000000000000e+00
        mat[1][0] = -1.00000000000000000e+00        
    elif order == 4:
        mat[0][0] = 0.00000000000000000e+00
        mat[0][1] = 0.00000000000000000e+00
        mat[0][2] = 5.00000000000000000e-01
        mat[1][0] = -2.00000000000000000e+00
        mat[1][1] = 4.00000000000000000e+00
        mat[1][2] = -1.50000000000000000e+00
        mat[2][0] = 1.00000000000000000e+01
        mat[2][1] = -8.00000000000000000e+00
        mat[2][2] = 1.50000000000000000e+00
        mat[3][0] = -8.00000000000000000e+00
        mat[3][1] = 4.00000000000000000e+00
        mat[3][2] = -5.00000000000000000e-01
    elif order == 6:
        mat[0][0] = 0.00000000000000000e+00
        mat[0][1] = 0.00000000000000000e+00
        mat[0][2] = 0.00000000000000000e+00
        mat[0][3] = 0.00000000000000000e+00
        mat[0][4] = 4.16666666666666644e-02
        mat[1][0] = -2.49999999999999972e-01
        mat[1][1] = 1.00000000000000000e+00
        mat[1][2] = -1.50000000000000000e+00
        mat[1][3] = 1.00000000000000000e+00
        mat[1][4] = -2.08333333333333315e-01
        mat[2][0] = 9.75000000000000000e+00
        mat[2][1] = -1.90000000000000000e+01
        mat[2][2] = 1.35000000000000000e+01
        mat[2][3] = -4.00000000000000000e+00
        mat[2][4] = 4.16666666666666741e-01
        mat[3][0] = -5.77500000000000000e+01
        mat[3][1] = 7.10000000000000000e+01
        mat[3][2] = -3.15000000000000000e+01
        mat[3][3] = 6.00000000000000000e+00
        mat[3][4] = -4.16666666666666741e-01
        mat[4][0] = 1.02249999999999986e+02
        mat[4][1] = -8.90000000000000000e+01
        mat[4][2] = 2.85000000000000000e+01
        mat[4][3] = -3.99999999999999956e+00
        mat[4][4] = 2.08333333333333315e-01
        mat[5][0] = -5.39999999999999858e+01
        mat[5][1] = 3.60000000000000000e+01
        mat[5][2] = -9.00000000000000000e+00
        mat[5][3] = 9.99999999999999889e-01
        mat[5][4] = -4.16666666666666644e-02
    elif order == 8:
        mat[0][0] = 0.00000000000000000e+00
        mat[0][1] = 0.00000000000000000e+00
        mat[0][2] = 0.00000000000000000e+00
        mat[0][3] = 0.00000000000000000e+00
        mat[0][4] = 0.00000000000000000e+00
        mat[0][5] = 0.00000000000000000e+00
        mat[0][6] = 1.38888888888888873e-03
        mat[1][0] = -1.11111111111111081e-02
        mat[1][1] = 6.66666666666666657e-02
        mat[1][2] = -1.66666666666666657e-01
        mat[1][3] = 2.22222222222222210e-01
        mat[1][4] = -1.66666666666666630e-01
        mat[1][5] = 6.66666666666666519e-02
        mat[1][6] = -9.72222222222222064e-03
        mat[2][0] = 2.47777777777777786e+00
        mat[2][1] = -7.39999999999999947e+00
        mat[2][2] = 9.16666666666666607e+00
        mat[2][3] = -6.00000000000000000e+00
        mat[2][4] = 2.16666666666666652e+00
        mat[2][5] = -3.99999999999999911e-01
        mat[2][6] = 2.91666666666666671e-02
        mat[3][0] = -5.42222222222222285e+01
        mat[3][1] = 1.06000000000000000e+02
        mat[3][2] = -8.53333333333333286e+01
        mat[3][3] = 3.59999999999999929e+01
        mat[3][4] = -8.33333333333333215e+00
        mat[3][5] = 1.00000000000000000e+00
        mat[3][6] = -4.86111111111111049e-02
        mat[4][0] = 3.44000000000000057e+02
        mat[4][1] = -4.91333333333333371e+02
        mat[4][2] = 2.88000000000000000e+02
        mat[4][3] = -8.84444444444444429e+01
        mat[4][4] = 1.50000000000000000e+01
        mat[4][5] = -1.33333333333333326e+00
        mat[4][6] = 4.86111111111111049e-02
        mat[5][0] = -8.71277777777777601e+02
        mat[5][1] = 9.66999999999999886e+02
        mat[5][2] = -4.41166666666666629e+02
        mat[5][3] = 1.05999999999999986e+02
        mat[5][4] = -1.41666666666666643e+01
        mat[5][5] = 9.99999999999999778e-01
        mat[5][6] = -2.91666666666666671e-02
        mat[6][0] = 9.43122222222222035e+02
        mat[6][1] = -8.47399999999999864e+02
        mat[6][2] = 3.14833333333333258e+02
        mat[6][3] = -6.19999999999999858e+01
        mat[6][4] = 6.83333333333333215e+00
        mat[6][5] = -3.99999999999999911e-01
        mat[6][6] = 9.72222222222222064e-03
        mat[7][0] = -3.64088888888888846e+02
        mat[7][1] = 2.73066666666666606e+02
        mat[7][2] = -8.53333333333333144e+01
        mat[7][3] = 1.42222222222222214e+01
        mat[7][4] = -1.33333333333333304e+00
        mat[7][5] = 6.66666666666666519e-02
        mat[7][6] = -1.38888888888888873e-03
    else :
        raise RuntimeError ("order %d not implemented!", order)
    return mat


class Bspline (object) :
    def __init__ (self,
                  order = 4) :
        self.order = int(order)
        self.holder = self.order * 0.5
        self.coeff = _make_bspline_coeff (self.order)
        self.coeff_d = _make_bspline_d_coeff (self.order)

    def _element (self,
                  xx) :
        if (xx <= - self.holder or xx >= self.holder) : 
            return 0
        nx = xx + self.holder
        tmpa = self.coeff[int(nx)]
        buff = tmpa[self.order-1]
        for ii in range (self.order - 2, -1, -1) :
            buff = buff * nx + tmpa[ii]
        return buff

    def _element_d (self,
                    xx) :
        if (xx <= - self.holder or xx >= self.holder) : 
            return 0
        nx = xx + self.holder
        tmpa = self.coeff_d[int(nx)]
        buff = tmpa[self.order-2]
        for ii in range (self.order - 3, -1, -1) :
            buff = buff * nx + tmpa[ii]
        return buff
    
    def __call__ (self, 
                  xx) : 
        result = np.zeros (np.prod(xx.shape))
        count = 0
        for ii in np.nditer (xx) :
            result[count] = self._element(ii)
            count = count + 1
        result.reshape (xx.shape)
        return result

    def deriv (self, 
               xx) : 
        result = np.zeros (np.prod(xx.shape))
        count = 0
        for ii in np.nditer (xx) :
            result[count] = self._element_d(ii)
            count = count + 1
        result.reshape (xx.shape)
        return result
    
if __name__ == "__main__" :
    bspline = Bspline(4)
    x = np.arange (-5, 5, 0.01)
    y = bspline(x)
    print (x.shape)
    print (y.shape)
    plt.plot (x, y)
    plt.show()
